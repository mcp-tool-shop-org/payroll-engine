{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "PSP Domain Event Schema Baseline",
  "description": "Baseline schema for event compatibility checking. DO NOT REMOVE fields.",
  "version": "2.0.0",
  "events": {
    "FundingRequested": {
      "description": "Emitted when a funding request is submitted for evaluation",
      "category": "funding",
      "payload": {
        "required": ["batch_id", "amount"],
        "optional": ["requested_at"]
      }
    },
    "FundingApproved": {
      "description": "Emitted when funding is approved",
      "category": "funding",
      "payload": {
        "required": ["batch_id"],
        "optional": ["reservation_id", "approved_at"]
      }
    },
    "FundingBlocked": {
      "description": "Emitted when funding is blocked due to insufficient funds or policy",
      "category": "funding",
      "payload": {
        "required": ["batch_id", "reason"],
        "optional": ["shortfall_amount", "policy_name"]
      }
    },
    "FundingInsufficientFunds": {
      "description": "Emitted when funding fails due to insufficient funds (pay gate)",
      "category": "funding",
      "payload": {
        "required": ["funding_request_id", "requested_amount", "available_balance", "shortfall"],
        "optional": ["gate_evaluation_id"]
      }
    },
    "PaymentInstructionCreated": {
      "description": "Emitted when a payment instruction is created",
      "category": "payment",
      "payload": {
        "required": ["instruction_id", "amount"],
        "optional": ["payee_name", "payee_type", "rail", "purpose"]
      }
    },
    "PaymentSubmitted": {
      "description": "Emitted when a payment is submitted to a provider",
      "category": "payment",
      "payload": {
        "required": ["instruction_id", "provider_ref"],
        "optional": ["provider_name", "rail"]
      }
    },
    "PaymentAccepted": {
      "description": "Emitted when a provider accepts a payment for processing",
      "category": "payment",
      "payload": {
        "required": ["instruction_id", "provider_ref"],
        "optional": ["expected_settlement_date"]
      }
    },
    "PaymentSettled": {
      "description": "Emitted when a payment is confirmed settled",
      "category": "settlement",
      "payload": {
        "required": ["instruction_id"],
        "optional": ["settlement_id", "provider_ref", "settled_at", "trace_id"]
      }
    },
    "PaymentReturned": {
      "description": "Emitted when a payment is returned by the bank",
      "category": "settlement",
      "payload": {
        "required": ["instruction_id", "return_code"],
        "optional": ["return_reason", "return_date"]
      }
    },
    "PaymentFailed": {
      "description": "Emitted when a payment submission fails",
      "category": "payment",
      "payload": {
        "required": ["instruction_id", "error_code"],
        "optional": ["error_message", "retry_after"]
      }
    },
    "PaymentCanceled": {
      "description": "Emitted when a payment is canceled before settlement",
      "category": "payment",
      "payload": {
        "required": ["instruction_id", "canceled_by", "cancel_reason"],
        "optional": ["was_submitted"]
      }
    },
    "LedgerEntryPosted": {
      "description": "Emitted when a ledger entry is posted",
      "category": "ledger",
      "payload": {
        "required": ["entry_id", "debit_account", "credit_account", "amount"],
        "optional": ["entry_type", "source_type", "source_id"]
      }
    },
    "LedgerEntryReversed": {
      "description": "Emitted when a ledger entry is reversed",
      "category": "ledger",
      "payload": {
        "required": ["entry_id", "reversal_entry_id"],
        "optional": ["reason"]
      }
    },
    "ReservationCreated": {
      "description": "Emitted when a balance reservation is created",
      "category": "funding",
      "payload": {
        "required": ["reservation_id", "account_id", "amount"],
        "optional": ["purpose", "expires_at"]
      }
    },
    "ReservationReleased": {
      "description": "Emitted when a balance reservation is released",
      "category": "funding",
      "payload": {
        "required": ["reservation_id"],
        "optional": ["release_type", "released_at"]
      }
    },
    "SettlementReceived": {
      "description": "Emitted when a settlement record is received from a provider",
      "category": "settlement",
      "payload": {
        "required": ["settlement_event_id", "bank_account_id", "amount", "external_trace_id"],
        "optional": ["rail", "direction", "effective_date", "status"]
      }
    },
    "SettlementMatched": {
      "description": "Emitted when a settlement is matched to a payment instruction",
      "category": "settlement",
      "payload": {
        "required": ["settlement_event_id", "payment_instruction_id"],
        "optional": ["payment_attempt_id", "match_method"]
      }
    },
    "SettlementUnmatched": {
      "description": "Emitted when a settlement could not be matched to any instruction",
      "category": "settlement",
      "payload": {
        "required": ["settlement_event_id", "external_trace_id", "amount"],
        "optional": ["direction", "reason"]
      }
    },
    "SettlementStatusChanged": {
      "description": "Emitted when a settlement status changes",
      "category": "settlement",
      "payload": {
        "required": ["settlement_event_id", "previous_status", "new_status"],
        "optional": ["change_reason", "return_code", "requires_reversal"]
      }
    },
    "LiabilityClassified": {
      "description": "Emitted when liability is classified for a return",
      "category": "liability",
      "payload": {
        "required": ["instruction_id", "return_code", "liability_party"],
        "optional": ["error_origin", "recovery_path", "amount"]
      }
    },
    "LiabilityRecoveryStarted": {
      "description": "Emitted when recovery process starts for a liability",
      "category": "liability",
      "payload": {
        "required": ["liability_event_id", "recovery_path", "target_amount"],
        "optional": ["recovery_method"]
      }
    },
    "LiabilityRecovered": {
      "description": "Emitted when liability is successfully recovered",
      "category": "liability",
      "payload": {
        "required": ["liability_event_id", "recovered_amount", "recovery_method"],
        "optional": ["recovery_reference"]
      }
    },
    "LiabilityWrittenOff": {
      "description": "Emitted when liability is written off as unrecoverable",
      "category": "liability",
      "payload": {
        "required": ["liability_event_id", "written_off_amount", "write_off_reason"],
        "optional": ["approved_by", "accounting_reference"]
      }
    },
    "ReconciliationStarted": {
      "description": "Emitted when a reconciliation job starts",
      "category": "reconciliation",
      "payload": {
        "required": ["reconciliation_id", "reconciliation_date", "bank_account_id"],
        "optional": ["provider"]
      }
    },
    "ReconciliationCompleted": {
      "description": "Emitted when a reconciliation job completes successfully",
      "category": "reconciliation",
      "payload": {
        "required": ["reconciliation_id", "reconciliation_date", "records_processed"],
        "optional": ["records_matched", "records_created", "records_failed", "unmatched_count"]
      }
    },
    "ReconciliationFailed": {
      "description": "Emitted when a reconciliation job fails",
      "category": "reconciliation",
      "payload": {
        "required": ["reconciliation_id", "error_code", "error_message"],
        "optional": ["reconciliation_date", "records_processed_before_failure"]
      }
    }
  },
  "rules": {
    "immutable_event_names": true,
    "additive_payload_only": true,
    "required_fields_need_default_for_new": true
  }
}
